# Load libraries
library(data.table)
library(tidyverse) # Keep for potential data exploration, though not used in the main pipeline

#Loading files

stats_minute_1516 <- fread("stats_minute_1516.csv")
stats_minute_1516_renormalized <- fread("stats_minute_1516_renormalized.csv")
all_events_1516 <- fread("all_events_1516.csv")
all_events_1516_renormalized <- fread("all_events_1516_renormalized.csv")
matches_info_1516 <- fread("matches_info_1516.csv")
dataco_all_events <- fread("dataco_all_events.csv")
dataco_all_events_1516_prob<- fread("dataco_all_events_1516_prob.csv")
source('soccer-utility_prob_biv.R')




# Run the fitting process using the NEW bivariate functions
dataco_all_events_1516_bivariate_fit <- dataco_all_events_1516_prob[, {
  
  # Call the NEW bivariate fitWrapper
  params <- soccerutility.fitWrapper_bivariate_kn(
    cs_gen = soccerutility.cs_bivariate_kn, # Use the new score generator
    had = c(PSCH_prob, PSCD_prob, PSCA_prob),
    hilo = c(2.5, `BbAv<2.5_prob`, `BbAv>2.5_prob`)
  )
  
  # Assign the 5 returned values to their respective columns
  list(
    total_goals = params[1],
    supremacy = params[2],
    phi = params[3],         # The new draw mixture parameter
    cov_lambda = params[4],  # The new covariance parameter
    fit_error = params[5]    # The final error value
  )
  
}, by = .(match_id, id)]


# Display the first few rows of the final table, rounded for readability.
print("Optimized parameters for each match (rounded to 2 decimals):")

# Take the head of the results to create a temporary table for printing
dataco_all_events_1516_bivariate_fit_rounded <-dataco_all_events_1516_bivariate_fit

# Identify the numeric columns to round (excluding id columns)
cols_to_round <- c("total_goals", "supremacy", "draw_factor")

# Use a loop to round the specified columns by reference in the temporary table
for (col in cols_to_round) {
  dataco_all_events_1516_bivariate_fit_rounded[, (col) := round(get(col), 2)]
}

# Print the formatted table
print(dataco_all_events_1516_bivariate_fit_rounded)

#write.csv(dataco_all_events_1516_bivariate_fit_rounded, "dataco_all_events_1516_bivariate_fit_rounded.csv", row.names = FALSE)