# Load libraries
library(data.table)
library(dplyr)
library(ggplot2)
library(tidyverse)

library(plotly)


#Load the data

matches <- fread("matches_info_1516.csv")
dataco <- fread("dataco_all_events_1516_fitprob.csv")
events <- fread("all_events_1516_renormalized.csv")
statsr <- fread("stats_minute_1516_renormalized.csv")
stats <- fread("stats_minute_1516.csv")

#1 Prepare the data. For every minute of the match we want 1) goal home or goal away in that minute? 2) state of the match (current result and players on  the field for both teams).

#Sanity check, no more of one goal per minute
all(statsr$home_goal_now %in% c(0, 1)) && all(statsr$away_goal_now %in% c(0, 1))

#From the home team perspective
statsr$score_state <- statsr$home_goals - statsr$away_goals
statsr$numbers_players_state <- statsr$red_cards_away - statsr$red_cards_home

state_data <- statsr[, c("match_id", 
                     "minute", 
                     "home_goal_now", 
                     "away_goal_now", 
                     "score_state", 
                     "numbers_players_state")]

# 1. From `dataco`, select only the match_id and the pre-match expected goals.
pre_match_strengths <- dataco[, .(match_id, expH, expA)]

# 2. Merge these strengths into your state_data dataframe.
# The `merge` function will use the common column `match_id` to align the data correctly.
# It will automatically repeat the expH and expA values for every minute of each match.
state_data_full <- merge(state_data, pre_match_strengths, by = "match_id")

# 3. (Optional but recommended) Set the order for readability.
setorder(state_data_full, match_id, minute)


# 1. Create the 'home' perspective dataframe
home_df <- state_data_full[, .(
  match_id,
  minute,
  team = "home",
  goal_scored = home_goal_now,
  # Predictors from the home team's perspective
  score_diff = score_state, # (home_goals - away_goals)
  player_diff = numbers_players_state, # (away_reds - home_reds)
  own_expG = expH,
  opponent_expG = expA
)]


# 2. Create the 'away' perspective dataframe
away_df <- state_data_full[, .(
  match_id,
  minute,
  team = "away",
  goal_scored = away_goal_now,
  # Predictors from the away team's perspective (signs are flipped)
  score_diff = -score_state, # becomes (away_goals - home_goals)
  player_diff = -numbers_players_state, # becomes (home_reds - away_reds)
  own_expG = expA,
  opponent_expG = expH
)]


# 3. Combine the two dataframes into one long format
model_data <- rbind(home_df, away_df)

# 4. Set order for readability
setorder(model_data, match_id, minute, team)


# --- Fit the Binomial GLM ---
# Now you can fit one single model on this new, clean dataset.
goal_model <- glm(goal_scored ~ score_diff + player_diff + own_expG + opponent_expG, 
                  data = model_data, 
                  family = binomial(link = "logit"))

# View the model summary to see the results
summary(goal_model)


# --- NEW SECTION: Evaluate the model with a single example ---

# 1. Define the scenario
# We create a new data frame with two rows: one for the home team's perspective,
# and one for the away team's perspective in our chosen scenario.
# The column names MUST match the ones used to train the model.
scenario <- data.frame(
  # Home Team's Perspective
  score_diff = c(1),  # Winning 2-1, so score difference is +1
  player_diff = c(0), # No red cards
  own_expG = c(1.8),
  opponent_expG = c(1.2),
  
  # Away Team's Perspective
  score_diff = c(-1), # Losing 1-2, so score difference is -1
  player_diff = c(0), # No red cards
  own_expG = c(1.2),
  opponent_expG = c(1.8)
)

# 2. Use the model to predict the probabilities
# The `type = "response"` argument is crucial. It converts the model's raw output
# (log-odds) into an intuitive probability between 0 and 1.

predicted_probabilities_raw <- predict(goal_model, newdata = scenario, type = "response")

# --- MODIFICATION: Remove the names to prevent the warning ---
predicted_probabilities <- unname(predicted_probabilities_raw)

# 3. Display the results in a clear format
results <- data.frame(
  Team = c("Home", "Away"),
  Scenario = c("Winning 2-1, 75th min", "Losing 1-2, 75th min"),
  Probability_of_Scoring_in_this_Minute = predicted_probabilities
)

cat("\n--- Model Prediction for a Single Scenario ---\n")
print(results, row.names = FALSE)